<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Livraria - Web</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='Logo Aoros.png') }}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body class="bg-light">
<div class="container py-4">

    <div class="d-flex align-items-center mb-3">
    <img src="{{ url_for('static', filename='Logo Aoros.png') }}" alt="Logo" width="64" height="64" class="me-3 logo-img">
    <div>
      <h1 class="h4 mb-0">Sistema da Livraria Aoros</h1>
      <small class="text-muted">Valores dos Livros baseados na Amazon</small>
    </div>
  </div>

    <div class="card mb-3">
    <div class="card-body">
      <form id="form-add" class="row g-3">
        <div class="col-md-3">
          <input id="titulo" class="form-control" placeholder="Título" required>
        </div>
        <div class="col-md-3">
          <input id="autor" class="form-control" placeholder="Autor" required>
          </div>
        <div class="col-md-2">
          <input id="ano" class="form-control" placeholder="Ano" type="number" min="1000" max="2050">
        </div>
        <div class="col-md-2">
          <input id="preco" class="form-control" placeholder="Preço" type="text" inputmode="decimal" pattern="[0-9]+([,\.][0-9]+)?" title="Use ponto ou vírgula para decimais">
        </div>
        <div class="col-md-2 d-grid">
          <button class="btn btn-primary" type="submit">Adicionar</button>
        </div>
      </form>
    </div>
  </div>

    <div class="d-flex gap-2 mb-3 flex-wrap">
    <button id="btn-export" class="btn btn-outline-success">Exportar CSV</button>
    <label class="btn btn-outline-secondary mb-0">
      Importar CSV <input id="file-import" type="file" accept=".csv" hidden>
    </label>
    <button id="btn-backup" class="btn btn-outline-warning">Backup Manual</button>
    <button id="btn-html" class="btn btn-outline-info">Relatório HTML</button>
    <button id="btn-pdf" class="btn btn-outline-dark">Relatório PDF</button>
    <input id="search" class="form-control ms-auto" style="max-width: 250px;" placeholder="Buscar autor...">
    </div>

    <div class="card">
    <div class="card-body p-2">
      <div id="msg" class="mb-2"></div>
      <div class="table-responsive">
        <table class="table table-sm table-hover" id="tbl-books">
          <thead class="table-light">
            <tr>
                <th class="text-center">ID</th>
                <th>Título</th>
                <th>Autor</th>
                <th class="text-center">Ano</th>
                <th class="text-end">Preço</th>
                <th>Ações</th>             </tr>
          </thead>
          <tbody>
              </tbody>
        </table>
        </div>
      </div>
    </div>

</div>

<script>
const api = {
  list: "/api/books",
  add: "/api/books",
  updatePrice: (id) => `/api/books/${id}/price`,
  delete: (id) => `/api/books/${id}`,
  search: (q) => `/api/search?q=${encodeURIComponent(q)}`,
  export: "/api/export",
  import: "/api/import",
  backup: "/api/backup",
  reportHtml: "/api/report/html",
  reportPdf: "/api/report/pdf" 
};

async function showMsg(text, type = "info") {
  const el = document.getElementById("msg");
  el.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">${text}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
}

async function fetchBooks() {
  try {
    const res = await fetch(api.list);
    const data = await res.json();
    renderTable(data);
  } catch (e) {
    showMsg("Erro ao carregar livros: O servidor pode estar offline.", "danger");
  }
}

function formatPrice(price) {
    if (price === null || price === undefined) return '<span class="text-muted">N/A</span>';
    return Number(price).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
}

function formatYear(year) {
    return year || '<span class="text-muted">N/A</span>';
}

function renderTable(books) {
  const tbody = document.querySelector("#tbl-books tbody");
  tbody.innerHTML = "";
  if (books.length === 0) {
    // colspan ajustado para 6 colunas (ID, Título, Autor, Ano, Preço, Ações)
    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-3">Nenhum livro cadastrado.</td></tr>';
    return;
  }
  for (const b of books) {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td class="text-center">${b.id}</td>
      <td>${escapeHtml(b.titulo)}</td>
      <td>${escapeHtml(b.autor)}</td>
      <td class="text-center">${formatYear(b.ano_publicacao)}</td>
      <td class="text-end fw-bold">${formatPrice(b.preco)}</td>
      <td class="text-nowrap">
        <button class="btn btn-sm btn-outline-primary me-1" onclick="promptPrice(${b.id})">Editar Preço</button>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteBook(${b.id})">Remover</button>
      </td>`;
    tbody.appendChild(tr);
  }
}

function escapeHtml(s) { return (s || "").replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll('"', "&quot;").replaceAll("'", "&#39;"); }


// === FUNÇÕES DE AÇÃO RESTAURADAS ===

async function promptPrice(id) {
  const novo = prompt("Novo preço (ex: 45.90 ou 45,90):");
  if (novo === null || novo.trim() === "") return;
  // LIMPEZA: Substitui vírgula por ponto para o backend processar como float padrão
  const preco_formatado = novo.trim().replace(',', '.');

  const res = await fetch(api.updatePrice(id), { 
    method: "PUT", 
    headers: { "Content-Type": "application/json" }, 
    body: JSON.stringify({ preco: preco_formatado }) 
  });

  if (res.ok) { 
    showMsg("Preço atualizado com sucesso. Backup automático criado.", "success"); 
    fetchBooks(); 
  }
  else { 
    const j = await res.json(); 
    showMsg(j.error || "Erro ao atualizar preço.", "danger"); 
  }
}

async function deleteBook(id) {
  if (!confirm(`Confirmar remoção do livro ID ${id}?`)) return;

  const res = await fetch(api.delete(id), { method: "DELETE" });

  if (res.ok) { 
    showMsg("Livro removido. Backup automático criado.", "success"); 
    fetchBooks(); 
  }
  else { 
    const j = await res.json(); 
    showMsg(j.error || "Erro ao remover livro.", "danger"); 
  }
}

// === Event Listeners ===

document.getElementById("form-add").addEventListener("submit", async (e) => {
  e.preventDefault();
  const titulo = document.getElementById("titulo").value.trim();
  const autor = document.getElementById("autor").value.trim();
  const ano = document.getElementById("ano").value.trim();
  // LIMPEZA: Substitui vírgula por ponto para o backend processar como float padrão
  const preco = document.getElementById("preco").value.trim().replace(',', '.'); 

  const body = { titulo, autor, ano_publicacao: ano || null, preco: preco || null };

  const res = await fetch(api.add, { 
    method: "POST", 
    headers: { "Content-Type": "application/json" }, 
    body: JSON.stringify(body) 
  });

  if (res.ok) {
    showMsg("Livro adicionado com sucesso. Backup automático criado.", "success");
    document.getElementById("form-add").reset();
    document.getElementById("preco").value = '';
    fetchBooks();
  } else {
    const j = await res.json();
    showMsg(j.error || "Erro ao adicionar livro. Verifique os campos.", "danger");
  }
});

document.getElementById("btn-export").addEventListener("click", () => {
  showMsg("Preparando download do CSV...", "info");
  window.location = api.export;
});

document.getElementById("file-import").addEventListener("change", async (e) => {
  const f = e.target.files[0];
  if (!f) return;
  
  showMsg(`Importando ${f.name}...`, "info");
  const form = new FormData();
  form.append("file", f);
  
  try {
    const res = await fetch(api.import, { method: "POST", body: form });
    const j = await res.json();
    if (res.ok) { 
      showMsg(`${j.inserted} registros importados. Backup automático criado.`, "success"); 
      fetchBooks(); 
    }
    else {
      showMsg(j.error || "Erro ao importar CSV.", "danger");
    }
  } catch (e) {
    showMsg("Erro de rede ou servidor ao importar CSV.", "danger");
  }
  e.target.value = ''; 
});

document.getElementById("btn-backup").addEventListener("click", async () => {
  showMsg("Criando backup manual...", "info");
  const res = await fetch(api.backup);
  const j = await res.json();
  if (res.ok) showMsg(`Backup manual criado em: ${j.backup}`, "success");
  else showMsg("Erro ao criar backup.", "danger");
});

document.getElementById("btn-html").addEventListener("click", () => {
  showMsg("Preparando download do Relatório HTML...", "info");
  window.location = api.reportHtml; 
});

document.getElementById("btn-pdf").addEventListener("click", () => {
  showMsg("Gerando Relatório PDF...", "info");
  window.location = api.reportPdf; 
});

document.getElementById("search").addEventListener("input", async (e) => {
  const q = e.target.value.trim();
  
  if (q === "") { 
    fetchBooks(); 
    return; 
  }
  
  const res = await fetch(api.search(q));
  const data = await res.json();
  renderTable(data);
});

fetchBooks();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
